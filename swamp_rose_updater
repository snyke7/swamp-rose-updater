#!/bin/bash

MANIFEST_URL='https://updates.roseonlinegame.com'

update_lines=$(curl --silent -L "$MANIFEST_URL"'/manifest.json' | jq -r '.files | [ .[] | [ .[] ] | [ .[0], .[1], ( .[2] | @sh ), .[3] ] ] | .[] | @sh')

to_hash_str () {
   the_array=("$@")
   for i in "${the_array[@]}" ; do
      printf "%02x" "$i"
   done
   printf '\n'
}

if [ ! -d "rose-test-folder" ] ; then
   echo "Copying rose folder to experiment on..."
   cp -r rose-source-folder rose-test-folder
fi

cd rose-test-folder

while read -r update_line; do
   declare -a the_array="($update_line)"
   path_tail=${the_array[0]}
   filename=${the_array[1]}
   declare -a almost_hash="(${the_array[2]})"
   the_hash=$(to_hash_str "${almost_hash[@]}")
   filesize=${the_array[3]}
   archive_url="$MANIFEST_URL""/$path_tail"
   if ! echo "$the_hash $(pwd)/$filename" | b2sum --check --status - ; then
      echo "Updating $filename ..."
      bita clone --seed-output "$archive_url" "$filename"
      echo
   fi
done <<< "$update_lines"



